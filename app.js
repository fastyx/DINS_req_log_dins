//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const express = require('express');
const cors = require('cors');
const compression = require('compression');
const serveIndex = require('serve-index')
const logger = require('./config/logger');
const config = require('./init_config');
const pjson = require('./package.json');
const routes = require('./src/routes/routes');
const conn = require('./src/connection/get-connect');
const app = express();
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
app.use(compression());
app.use(cors());
app.use(express.json({ limit: '100mb' }));
app.use('/appinfo/logs', express.static(`${__dirname}/logs`), serveIndex(`${__dirname}/logs`, { 'icons': true }))
app.use('/', routes);
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Логирование запуска текущей версии
logger.info(`${config.serviceName}: Version: ${pjson.version}`);
logger.info(`${config.serviceName}: Start configuration: ${JSON.stringify(config)}`);
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
app.listen(config.SYSTEM.restConfig.reqLogDinsService.port, async () => {

    logger.info(`${config.serviceName}: server started. Port: ${config.SYSTEM.restConfig.reqLogDinsService.port}`);

    client = await conn.getConnect();

    // инициализация consumer
    require("./src/modules/consumer");

});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////